[ req ]
default_bits = 2048
default_md = sha256
distinguished_name = req_distinguished_name

[req_distinguished_name]

[ v3_ca ]
basicConstraints = critical, CA:TRUE
keyUsage = critical, digitalSignature, keyEncipherment, keyCertSign

[ v3_req_server ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_kube_apiserver

[ v3_req_kubelet ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_kubelet

[ v3_req_client ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth

[ alt_kube_apiserver ]
DNS.1 = localhost
DNS.2 = kubernetes
DNS.3 = kubernetes.default
DNS.4 = kubernetes.default.svc
DNS.5 = *.{{ karmada_namespace }}.svc.{{ cluster_domain }}
DNS.6 = *.{{ karmada_namespace }}.svc
{% set dns_idx = 6 | int %}
{% for sub_domain in dns_domain.split('.') %}
{% set outer_loop = loop %}
DNS.{{ dns_idx + loop.index }} = kubernetes.default.svc.{% for domain in dns_domain.split('.') %}{% if loop.index <= outer_loop.index %}{{ domain }}{% if loop.index < outer_loop.index %}.{% endif %}{% endif %}{% endfor %}

{% endfor %}
{% set dns_idx = 6 + (dns_domain.split('.')|length) | int %}
{% if hostvars[inventory_hostname]['ansible_ssh_host'] is defined %}
{% set dns_idx = 6 + dns_domain.split('.')|length | int %}
{% endif %}
IP.1 = 127.0.0.1
IP.2 = 0:0:0:0:0:0:0:1
IP.3 = {{ kubernetes_service_ip }}
{% if api_server.load_balancer_apiserver_ip != "" %}
IP.4 = {{ api_server.load_balancer_apiserver_ip | trim }}
{% endif %}


[ alt_kubelet ]
DNS.1 = localhost
IP.1 = 127.0.0.1